{% extends "layouts/base.html" %} {% block title %} Detail {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}<style>
  .seeBtn button {
    background-color: rgb(195, 83, 235);
    border: none;
    color: white;
    padding: 10px 15px;
  }
  .seeBtn button:hover {
    background-color: rgb(165, 70, 199);
  }
  .insight-text {
    color: black !important;
    font-size: medium;
    text-align: left;
    width: 90%;
    margin: auto;
    margin-top: 40px;
    margin-bottom: 40px;
    white-space: pre-wrap;
  }
  .graphs-container {
    background-color: rgb(239, 239, 239);
  }
  .graphs-container p {
    font-size: 20px;
  }
  .graphs-container h2 {
    margin-bottom: 20px;
    margin-top: 20px;
  }
  .graphs-container h1,
  .graphs-container h2,
  .graphs-container h4 {
    color: black;
  }
  .graphs-container h4 {
    font-size: 20px;
  }
  .graphs-container p {
    color: black;
  }
  .text-center {
    background-color: rgb(239, 239, 239);
  }
  .input-field p {
    color: black;
    font-size: medium;
  }
  #graphs-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }
  #graphs-container h4 {
    margin-top: 30px;
  }
  #prompt {
    width: 80%;
    height: 60px;
    font-size: 18px;
  }
  .input-field h2 {
    color: black;
    padding-top: 30px;
  }
  #process-btn {
    background-color: rgb(195, 83, 235);
    border: none;
    color: white;
    margin-top: 20px;
    padding: 10px 45px;
  }
  #process-btn:hover {
    background-color: rgb(168, 71, 203);
  }
  @keyframes rollDown {
    from {
      opacity: 0;
      max-height: 0;
    }
    to {
      opacity: 1;
      max-height: 200px; /* Adjust based on your content */
    }
  }

  @keyframes rollUp {
    from {
      opacity: 1;
      max-height: 200px; /* Match rollDown */
    }
    to {
      opacity: 0;
      max-height: 0;
    }
  }
  .toggle-button {
    cursor: pointer;
    background-color: rgb(195, 83, 235);
    border: none;
    color: white;
    padding: 5px 10px;
    width: 100%;
    font-size: 14px;
    display: inline-block;
  }
  .toggle-button:hover {
    background-color: rgb(168, 71, 203);
  }
  .plot-div {
    margin-bottom: 20px;
  }
  #regenerate-btn {
    background-color: yellow;
    color: black;
    border: none;
    padding: 10px 10px;
    font-size: 14px;
    display: inline-block;
  }
  #regenerate-btn:hover {
    background-color: rgb(209, 209, 0);
  }
  .delete-button {
    background-color: red;
    color: white;
    position: absolute;
    top: 0px;
    left: 0px;
    font-weight: bold;
    border: none;
    padding: 5px 10px;
  }
  .delete-button:hover {
    background-color: rgb(203, 0, 0);
  }
  .plotContainer {
    background-color: rgb(254, 254, 254);
    position: relative;
    margin-top: 40px;
    width: 49%;
  }
  #modal {
    display: none; /* Hidden by default */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }

  /* Modal content container */
  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    position: relative;
    max-height: 80%;
    overflow-y: scroll;
    width: 70%;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
  }

  /* Optional: Modal background */
  .modal-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
  }
  #deleteBtn {
    position: absolute;
    background-color: red;
    padding: 10px;
    font-size: large;
    border-radius: 5px;
    border: none;
    color: white;
    top: 0;
    right: 0;
  }
  #plotModalContainer {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
  #plotModalContainer h4 {
    font-size: 22px;
    text-align: center;
  }
</style>
{% endblock stylesheets %} {% block content %}
<div class="content">
  <div id="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      <button id="deleteBtn">X</button>
      <div id="plotModalContainer"></div>
    </div>
  </div>
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="upload-file">
          <div class="formContainer" style="width: 100%">
            <div class="text-center" style="width: 100%">
              <form id="upload-form" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="input-field">
                  <h2>Choose a prompt for the insight you want to generate</h2>
                  <textarea id="prompt" name="prompt"></textarea>
                </div>
                <button id="process-btn">Add insight</button>
                <button id="regenerate-btn">Re-generate insights</button>
              </form>
              <div id="upload-status" class="alert" role="alert"></div>
              <div id="data-summary"></div>
              <div class="graphs-container">
                <h1>Files Details</h1>
                <p><strong>Upload Name:</strong> {{ fileData.uploadName }}</p>
                <p>
                  <strong>Processed:</strong>
                  {{fileData.processed|yesno:"Yes,No"}}
                </p>
                <p>
                  <strong>Validated:</strong>
                  {{fileData.validated|yesno:"Yes,No"}}
                </p>
                <p><strong>Created At:</strong> {{ fileData.created_at }}</p>
                <p><strong>Updated At:</strong> {{ fileData.updated_at }}</p>

                <h2>Plot Insight(s)</h2>
                <div id="graphs-container"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>
  const id = "{{fileData.id}}";
  const uploadStatus = $("#upload-status");
  const modal = document.getElementById("modal");
  const closeBtn = document.getElementById("deleteBtn");
  const plotModalContainer = document.getElementById("plotModalContainer");
  closeBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });
  let plotImages = [];
  function renderPlots(data) {
    plotImages = data.plot_path;
    const container = document.getElementById("graphs-container");
    container.innerHTML = "";
    plotImages.forEach((plotImage, index) => {
      // Create a new img element
      const plotContainer = document.createElement("div");
      plotContainer.classList.add("plotContainer");
      const plotDiv = document.createElement("div");
      plotDiv.setAttribute("id", `plot-${index}`);
      const description = document.createElement("h4");
      const insight = document.createElement("p");
      const contextHeader=document.createElement("h3");
      const contextContent=document.createElement("p");
      contextHeader.innerHTML="Context to generate insight"
      contextContent.innerHTML=plotImage.context;
      contextContent.style.whiteSpace="pre-wrap";
      description.innerHTML = plotImage.description;
      insight.innerHTML = plotImage.insight;
      insight.classList.add("insight-text");
      insight.style.display = "none";
      //Button to reveal insight
      const toggleButton = document.createElement("button");
      //Button to delete insight
      const deleteBtn = document.createElement("button");
      deleteBtn.classList.add("delete-button");
      deleteBtn.innerHTML = "Delete insight";
      deleteBtn.style.display = "none";
      toggleButton.classList.add("toggle-button");
      toggleButton.innerHTML = "Show Insight â–¼";
      plotContainer.addEventListener("mouseover", () => {
        deleteBtn.style.display = "block";
        deleteBtn.style.animation = "rollDown 0.3s ease-out";
      });
      plotContainer.addEventListener("mouseleave", () => {
        deleteBtn.style.animation = "rollUp 0.3s ease-out";
        setTimeout(() => {
          deleteBtn.style.display = "none";
        }, 300);
      });
      deleteBtn.addEventListener("click", () => {
        deleteInsight(data.id, index);
      });
      toggleButton.addEventListener("click", () => {
        plotModalContainer.innerHTML = ""; // Clear existing modal content

        const modalPlotDiv = document.createElement("div");
        modalPlotDiv.setAttribute("id", `modal-plot-${index}`);
        modalPlotDiv.classList.add("modal-plot-div");
        const modalDescription = document.createElement("h4");
        modalDescription.innerHTML = plotImage.description;

        const modalInsight = document.createElement("p");
        modalInsight.innerHTML = plotImage.insight;
        modalInsight.classList.add("insight-text");

        // Append content to the modal
        plotModalContainer.appendChild(modalDescription);
        plotModalContainer.appendChild(modalPlotDiv);
        plotModalContainer.appendChild(contextHeader);
        plotModalContainer.appendChild(contextContent);
        plotModalContainer.appendChild(modalInsight);

        // Render the plot in the modal
        Plotly.react(`modal-plot-${index}`, JSON.parse(plotImage.plotDiv));

        modal.style.display = "flex"; // Show the modal
      });
      // Add the plot html
      // Append the image to the container
      plotContainer.appendChild(deleteBtn);
      plotContainer.appendChild(description);
      plotContainer.appendChild(plotDiv);
      plotContainer.appendChild(toggleButton);
      plotContainer.appendChild(insight);
      container.appendChild(plotContainer);
      Plotly.react(`plot-${index}`, JSON.parse(plotImage.plotDiv), {});
    });
  }
  async function loadPlots() {
    try {
      const response = await fetch(`/getPlots/${id}/`);
      const data = await response.json();
      if (data.status === "success") {
        renderPlots(data);
      }
    } catch (err) {
      console.log(err);
    }
  }
  const regenBtn = document.getElementById("regenerate-btn");
  const addBtn = document.getElementById("process-btn");
  regenBtn.addEventListener("click", function (e) {
    e.preventDefault();
    uploadStatus
      .removeClass()
      .addClass("alert alert-info")
      .text("Processing...")
      .show();
    reprompt();
  });
  addBtn.addEventListener("click", function (e) {
    e.preventDefault();
    uploadStatus
      .removeClass()
      .addClass("alert alert-info")
      .text("Processing...")
      .show();
    addInsight();
  });
  async function reprompt() {
    const promptInput = document.getElementById("prompt");
    const uploadData = {
      id: id,
      prompt: promptInput.value,
    };
    try {
      const response = await fetch("/reprompt/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val(),
        },
        body: JSON.stringify(uploadData),
      });
      const data = await response.json();
      if (data.status === "success") {
        uploadStatus
          .removeClass()
          .addClass("alert alert-success")
          .text("Regenerate insight successfully!")
          .show();
        renderPlots(data);
      }
    } catch (err) {
      console.log(err);
    }
  }
  async function addInsight() {
    const promptInput = document.getElementById("prompt");
    const descriptions = plotImages
      .map((image) => image.description)
      .join(", ");
    const uploadData = {
      id: id,
      prompt: `${promptInput.value}. Don't create plots that may repeat these descriptions: ${descriptions}`,
    };
    try {
      const response = await fetch("/add_insight/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val(),
        },
        body: JSON.stringify(uploadData),
      });
      const data = await response.json();
      if (data.status === "success") {
        uploadStatus
          .removeClass()
          .addClass("alert alert-success")
          .text("Add insights successfully!")
          .show();
        renderPlots(data);
      }
    } catch (err) {
      console.log(err);
    }
  }
  async function deleteInsight(fileId, index) {
    if (window.confirm("Do you want to delete this data?")) {
      try {
        const response = await fetch("/delete_insight/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": $("input[name=csrfmiddlewaretoken]").val(),
          },
          body: JSON.stringify({
            id: fileId,
            delete_index: index,
          }),
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("Delete insight successfully");
          window.location.reload();
        }
      } catch (err) {
        console.log(err);
      }
    }
  }
  document.addEventListener("DOMContentLoaded", loadPlots);
</script>

{% endblock javascripts %}
